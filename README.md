# Ansible Playbooks Lab Testing (Docker + Docker Compose)

This lab creates a **fully isolated Ansible test environment** using Docker and Docker Compose:

- **1 Ansible Master node** (control node)  
- **4 managed nodes** representing environments: **dev / sit / uat / prod**
- Passwordless SSH from `ansible-master` ➜ each environment node
- Sample playbooks and roles to test common automation requirements:
  - Docker installation (demo)
  - NGINX installation
  - User creation + SSH key management
  - Secrets with **Ansible Vault** (password generated by a Python utility)

> ✅ Works great for learning, interview practice, and safely testing playbooks without touching real servers.

---

## 1) Required Software Tools Used

Install these on your **local system** (host machine):

### A. Docker Engine
- Required to run containers.

### B. Docker Compose
- Required to orchestrate multi-container setup (`ansible-master`, `dev`, `sit`, `uat`, `prod`).

### C. Git (optional but recommended)
- For cloning and version control.

### D. Python 3 (optional on host)
- Not required if you run the utility inside `ansible-master` container (recommended).
- If you want to run the utility on host, install Python 3.

### E. Visual Studio Code / any editor (optional)
- For editing YAML, Dockerfiles, and scripts comfortably.

---

## 2) How to Setup and Run Docker & Docker Compose

### Verify installation
```bash
docker --version
docker compose version
```

### Start Docker
- Windows/macOS: Start **Docker Desktop**
- Linux: Ensure Docker daemon is running:
```bash
sudo systemctl status docker
sudo systemctl start docker
```

### Confirm Docker is running
```bash
docker ps
```

---

## 3) Purpose of Creating ansible-master + dev/sit/uat/prod Nodes

### Why ansible-master?
This container acts like your **control node**, containing:
- `ansible`, `ansible-playbook`
- SSH client tools
- Inventory + playbooks + roles
- Vault tools and utilities

### Why multiple environment nodes?
Real projects run automation across multiple environments. This lab simulates that:

| Node | Purpose |
|------|---------|
| dev  | early testing, fast iteration |
| sit  | system integration testing |
| uat  | business/user acceptance testing |
| prod | production simulation (safe in lab) |

You can validate:
- playbook compatibility across environments
- inventory targeting (run only dev, or only prod, etc.)
- group_vars behavior
- role reuse

---

## 4) Two Dockerfiles

You will maintain **two different Dockerfiles**:

### A. Dockerfile for `ansible-master`
Purpose:
- Install Ansible
- Add SSH tools
- Copy lab workspace (inventory, playbooks, roles, scripts)

**Example: `docker/ansible-master/Dockerfile`**
```dockerfile
FROM ubuntu:22.04

ENV DEBIAN_FRONTEND=noninteractive

RUN apt-get update && apt-get install -y     python3 python3-pip python3-venv     openssh-client openssh-server     sshpass     git     vim nano     curl     && rm -rf /var/lib/apt/lists/*

RUN pip3 install --no-cache-dir ansible

# Create workspace
WORKDIR /lab

# Copy all lab content into container
COPY . /lab

# Ensure scripts are executable
RUN chmod +x scripts/bootstrap_ssh.sh scripts/generate_vault_password.py

CMD ["bash"]
```

### B. Dockerfile for managed nodes (dev/sit/uat/prod)
Purpose:
- Provide SSH server
- Provide a “Linux server-like” target for Ansible

**Example: `docker/nodes/Dockerfile`**
```dockerfile
FROM ubuntu:22.04

ENV DEBIAN_FRONTEND=noninteractive

RUN apt-get update && apt-get install -y     openssh-server sudo     python3     curl     && rm -rf /var/lib/apt/lists/*

# Prepare SSH
RUN mkdir -p /var/run/sshd

# Create a default SSH user (example: ansible)
RUN useradd -m -s /bin/bash ansible && echo "ansible:ansible" | chpasswd &&     usermod -aG sudo ansible &&     echo "ansible ALL=(ALL) NOPASSWD:ALL" >> /etc/sudoers

# Allow password SSH for initial bootstrap (keys will replace password later)
RUN sed -i 's/#PasswordAuthentication yes/PasswordAuthentication yes/' /etc/ssh/sshd_config &&     sed -i 's/#PubkeyAuthentication yes/PubkeyAuthentication yes/' /etc/ssh/sshd_config

EXPOSE 22

CMD ["/usr/sbin/sshd", "-D"]
```

---

## 5) docker-compose.yml (Lab Topology)

Compose builds:
- `ansible-master` from Ansible Dockerfile
- `dev/sit/uat/prod` from nodes Dockerfile

**Example: `docker-compose.yml`**
```yaml
services:
  ansible-master:
    build:
      context: .
      dockerfile: docker/ansible-master/Dockerfile
    container_name: ansible-master
    tty: true
    volumes:
      - ./:/lab
    networks:
      - ansible-net

  dev:
    build:
      context: .
      dockerfile: docker/nodes/Dockerfile
    container_name: dev-node
    networks:
      - ansible-net

  sit:
    build:
      context: .
      dockerfile: docker/nodes/Dockerfile
    container_name: sit-node
    networks:
      - ansible-net

  uat:
    build:
      context: .
      dockerfile: docker/nodes/Dockerfile
    container_name: uat-node
    networks:
      - ansible-net

  prod:
    build:
      context: .
      dockerfile: docker/nodes/Dockerfile
    container_name: prod-node
    networks:
      - ansible-net

networks:
  ansible-net:
    driver: bridge
```

---

## 6) Folder Structure (Recommended)

```text
ansible-lab/
├─ docker-compose.yml
├─ docker/
│  ├─ ansible-master/
│  │  └─ Dockerfile
│  └─ nodes/
│     └─ Dockerfile
├─ inventory/
│  └─ hosts.ini
├─ group_vars/
│  ├─ all.yml
│  ├─ dev.yml
│  ├─ sit.yml
│  ├─ uat.yml
│  └─ prod.yml
├─ roles/
│  ├─ users/
│  │  ├─ tasks/main.yml
│  │  └─ vars/main.yml
│  ├─ nginx/
│  │  └─ tasks/main.yml
│  └─ docker/
│     └─ tasks/main.yml
├─ site.yml
├─ vault/
│  ├─ secrets.yml
│  └─ .gitignore
└─ scripts/
   ├─ bootstrap_ssh.sh
   └─ generate_vault_password.py
```

---

## 7) bootstrap_ssh.sh — Passwordless SSH Setup (Detailed)

### Goal
From the **ansible-master** container:
1. Generate an SSH keypair (if not already present)
2. Copy the **public key** into each node’s:
   - `/home/ansible/.ssh/authorized_keys`

This enables:
- `ansible-master` ➜ `dev/sit/uat/prod`  
without requiring password prompts.

### Why this matters
Ansible uses SSH for remote access. In real environments you must avoid passwords:
- better security
- automation-friendly
- works in CI/CD pipelines

### Example script: `scripts/bootstrap_ssh.sh`
```bash
#!/usr/bin/env bash
set -euo pipefail

SSH_USER="${SSH_USER:-ansible}"
NODES=("dev-node" "sit-node" "uat-node" "prod-node")

echo "==> Creating SSH keys (if missing)..."
mkdir -p /root/.ssh
chmod 700 /root/.ssh

if [ ! -f /root/.ssh/id_rsa ]; then
  ssh-keygen -t rsa -b 4096 -N "" -f /root/.ssh/id_rsa
fi

PUBKEY="$(cat /root/.ssh/id_rsa.pub)"

echo "==> Installing public key into nodes..."
for node in "${NODES[@]}"; do
  echo "----> Node: ${node}"

  # Create .ssh and authorized_keys on the node and apply permissions
  sshpass -p "${SSH_USER}" ssh -o StrictHostKeyChecking=no "${SSH_USER}@${node}"     "mkdir -p /home/${SSH_USER}/.ssh &&      chmod 700 /home/${SSH_USER}/.ssh &&      touch /home/${SSH_USER}/.ssh/authorized_keys &&      chmod 600 /home/${SSH_USER}/.ssh/authorized_keys &&      chown -R ${SSH_USER}:${SSH_USER} /home/${SSH_USER}/.ssh"

  # Append key (avoid duplicates)
  sshpass -p "${SSH_USER}" ssh -o StrictHostKeyChecking=no "${SSH_USER}@${node}"     "grep -qxF '${PUBKEY}' /home/${SSH_USER}/.ssh/authorized_keys || echo '${PUBKEY}' >> /home/${SSH_USER}/.ssh/authorized_keys"
done

echo "✅ Passwordless SSH bootstrap completed."
```

> Note: For demo simplicity, this script uses `sshpass` with password `ansible`.
> After keys are installed, SSH works without `sshpass`.

---

## 8) inventory/hosts.ini (How targeting works)

Ansible uses inventory to know:
- which hosts exist
- which groups they belong to
- how to connect

**Example: `inventory/hosts.ini`**
```ini
[dev]
dev-node ansible_user=ansible

[sit]
sit-node ansible_user=ansible

[uat]
uat-node ansible_user=ansible

[prod]
prod-node ansible_user=ansible

[all:vars]
ansible_python_interpreter=/usr/bin/python3
ansible_ssh_common_args='-o StrictHostKeyChecking=no'
```

Now you can run:
- `ansible dev -m ping`
- `ansible prod -m ping`
- `ansible all -m ping`

---

## 9) group_vars (How variables are applied)

`group_vars` lets you define variables per environment group.

### Example: `group_vars/all.yml`
```yaml
ssh_user: ansible
app_home_dir: /opt/app
common_packages:
  - curl
  - vim
```

### Example: `group_vars/dev.yml`
```yaml
env_name: dev
app_user: devusr
nginx_port: 8081
```

### Example: `group_vars/prod.yml`
```yaml
env_name: prod
app_user: produsr
nginx_port: 80
```

**How it works**
- When you run a playbook on `dev`, Ansible loads:
  - `group_vars/all.yml`
  - `group_vars/dev.yml`
- Same for sit/uat/prod

So the *same playbook* behaves differently based on group variables.

---

## 10) Roles (Explaining each role and tasks)

Roles keep playbooks **modular and reusable**.

### A. Role: `users`
Purpose:
- Create environment-specific application user (`app_user`)
- Setup home directory or application directories
- Add authorized keys, permissions, etc.

**Example: `roles/users/tasks/main.yml`**
```yaml
- name: Ensure application user exists
  ansible.builtin.user:
    name: "{{ app_user }}"
    shell: /bin/bash
    create_home: true

- name: Ensure app directory exists
  ansible.builtin.file:
    path: "{{ app_home_dir }}"
    state: directory
    owner: "{{ app_user }}"
    group: "{{ app_user }}"
    mode: "0755"
```

### B. Role: `nginx`
Purpose:
- Install NGINX
- Start and enable it
- Validate it is running
- Optional: configure listening port per environment

**Example: `roles/nginx/tasks/main.yml`**
```yaml
- name: Install NGINX
  ansible.builtin.apt:
    name: nginx
    state: present
    update_cache: true

- name: Ensure NGINX is started
  ansible.builtin.service:
    name: nginx
    state: started
    enabled: true

- name: Verify NGINX is responding
  ansible.builtin.command: "curl -I http://localhost"
  register: nginx_check
  changed_when: false
  failed_when: nginx_check.rc != 0
```

### C. Role: `docker` (demo role)
Purpose:
- Demonstrate installing Docker packages on target nodes
- In real servers, you would install Docker via official repo

**Example: `roles/docker/tasks/main.yml`**
```yaml
- name: Install Docker prerequisites (demo)
  ansible.builtin.apt:
    name:
      - ca-certificates
      - curl
    state: present
    update_cache: true

- name: Install docker.io (Ubuntu repo)
  ansible.builtin.apt:
    name: docker.io
    state: present

- name: Ensure Docker service started
  ansible.builtin.service:
    name: docker
    state: started
    enabled: true
```

---

## 11) site.yml (Main playbook orchestrator)

`site.yml` is the entry point that applies roles in order.

**Example: `site.yml`**
```yaml
- name: Ansible Lab - Configure All Nodes
  hosts: all
  become: true
  roles:
    - users
    - nginx
    - docker
```

**How it works**
- `hosts: all` targets dev/sit/uat/prod
- `become: true` uses sudo on target nodes
- Roles execute in sequence

---

## 12) Vault (Secrets) — ansible-vault + password generator utility

### Why vault?
Secrets should NOT be stored as plain text in repo:
- passwords
- tokens
- API keys

Vault encrypts YAML data.

### A. Generate vault password (recommended inside ansible-master)
**Example: `scripts/generate_vault_password.py`**
```python
#!/usr/bin/env python3
import secrets
import string

alphabet = string.ascii_letters + string.digits + "!@#$%^&*()-_=+"
pwd = "".join(secrets.choice(alphabet) for _ in range(32))
print(pwd)
```

### B. Create a vault password file (local inside container)
Inside `ansible-master`:
```bash
python3 scripts/generate_vault_password.py > .vault_pass.txt
chmod 600 .vault_pass.txt
```

### C. Create an encrypted secrets file
```bash
ansible-vault create vault/secrets.yml --vault-password-file .vault_pass.txt
```

Example content inside `vault/secrets.yml` (you type this while creating it):
```yaml
db_password: "MyS3cretP@ssw0rd"
api_token: "token-123"
```

### D. Use vault vars in playbook
In `site.yml`:
```yaml
- name: Ansible Lab - Configure All Nodes
  hosts: all
  become: true
  vars_files:
    - vault/secrets.yml
  roles:
    - users
    - nginx
```

Then inside tasks you can use:
```yaml
- name: Print masked secret (demo)
  ansible.builtin.debug:
    msg: "db_password is set (value hidden)"
  no_log: true
```

> ✅ Always use `no_log: true` when secrets might print in logs.

---

## 13) Commands to Operate This Lab (Start ➜ Run ➜ Verify)

### Step 1 — Build and start containers
From your project root (host machine):
```bash
docker compose build
docker compose up -d
docker ps
```

### Step 2 — Enter into ansible-master container
```bash
docker exec -it ansible-master bash
cd /lab
```

### Step 3 — Bootstrap passwordless SSH to all nodes
```bash
bash scripts/bootstrap_ssh.sh
```

### Step 4 — Validate SSH connectivity
```bash
ssh ansible@dev-node "hostname"
ssh ansible@sit-node "hostname"
ssh ansible@uat-node "hostname"
ssh ansible@prod-node "hostname"
```

### Step 5 — Validate Ansible connectivity (Ping)
```bash
ansible --version
ansible -i inventory/hosts.ini all -m ping
```

### Step 6 — Run playbook for all nodes
```bash
ansible-playbook -i inventory/hosts.ini site.yml
```

### Step 7 — Run playbook for a single environment (example: dev)
```bash
ansible-playbook -i inventory/hosts.ini site.yml --limit dev
```

### Step 8 — Run only prod
```bash
ansible-playbook -i inventory/hosts.ini site.yml --limit prod
```

---

## 14) Verification on Other Nodes (dev/sit/uat/prod)

You can verify changes in two ways:

### A) Verify using Ansible ad-hoc commands (recommended)
```bash
ansible -i inventory/hosts.ini all -a "whoami"
ansible -i inventory/hosts.ini all -a "id {{ app_user }}" -b
ansible -i inventory/hosts.ini all -a "systemctl status nginx --no-pager" -b
ansible -i inventory/hosts.ini all -a "nginx -v" -b
```

### B) Verify by entering each node container
From your host machine:
```bash
docker exec -it dev-node bash
docker exec -it sit-node bash
docker exec -it uat-node bash
docker exec -it prod-node bash
```

Inside a node:
```bash
whoami
id ansible
ps aux | grep nginx
curl -I http://localhost
```

---

## 15) Troubleshooting Tips (Common)

### SSH “Permission denied”
- Re-run bootstrap:
```bash
bash scripts/bootstrap_ssh.sh
```
- Confirm key exists:
```bash
ls -la /root/.ssh
cat /root/.ssh/id_rsa.pub
```

### Ansible says variable undefined (e.g., ssh_user/app_user)
- Confirm group_vars exists and YAML is valid:
```bash
ls -la group_vars
ansible -i inventory/hosts.ini all -m debug -a "var=app_user"
```

### NGINX install fails
- Confirm apt works inside node
- Check DNS/network, or run:
```bash
ansible -i inventory/hosts.ini all -m apt -a "update_cache=true" -b
```

### Docker role may fail inside container nodes
Some container images won’t have full systemd support.
If `systemctl` fails in containers:
- Use `service nginx status` instead
- Or adjust nodes to run systemd-enabled base images
- For learning Ansible tasks, the role examples remain useful.

---

## 16) Clean Up

Stop containers:
```bash
docker compose down
```

Remove containers + volumes (if you add volumes later):
```bash
docker compose down -v
```

Rebuild from scratch:
```bash
docker compose down -v
docker compose build --no-cache
docker compose up -d
```

---

## 17) Next Enhancements (Optional)

- Add **CI pipeline** (GitLab CI / Jenkins) to run playbooks automatically
- Add **Ansible Lint**
- Add **Molecule** tests (role-level testing)
- Add **Secrets hygiene** (no_log, vault in CI, external secret store)
- Add **NGINX config template** (Jinja2 + handlers)
- Add **separate site playbooks per env** (dev.yml, prod.yml)

---

### Quick Reference (Most used commands)

```bash
# host
docker compose up -d
docker exec -it ansible-master bash

# inside ansible-master
bash scripts/bootstrap_ssh.sh
ansible -i inventory/hosts.ini all -m ping
ansible-playbook -i inventory/hosts.ini site.yml
```

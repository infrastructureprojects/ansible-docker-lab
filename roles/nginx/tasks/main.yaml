---
# =============================================================================
# NGINX Role â€“ Container-safe
# =============================================================================

- name: Install nginx
  ansible.builtin.apt:
    name: nginx
    state: present
    update_cache: true
  when: nginx_enable | bool

- name: Deploy nginx config (container-safe)
  ansible.builtin.template:
    src: default.conf.j2
    dest: "{{ nginx_conf_path }}"
    mode: "0644"
  notify: nginx reload (container)
  when: nginx_enable | bool

- name: Ensure nginx runtime directories exist (container-safe)
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
    owner: www-data
    group: www-data
    mode: "0755"
  loop:
    - /run/nginx
    - /var/log/nginx
  when: nginx_enable | bool

- name: Start nginx if not running (no systemd)
  ansible.builtin.shell: |
    pgrep nginx >/dev/null 2>&1 && exit 0
    nginx
  args:
    executable: /bin/bash
  changed_when: false
  failed_when: false
  when: nginx_enable | bool

- name: Validate nginx is responding locally
  ansible.builtin.shell: >
    curl -s -o /dev/null -w "%{http_code}"
    http://127.0.0.1:{{ nginx_port }}
  register: nginx_http
  changed_when: false
  failed_when: nginx_http.stdout != "200"
  when: nginx_enable | bool

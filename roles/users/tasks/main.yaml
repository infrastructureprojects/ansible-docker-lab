---
# =============================================================================
# Role: users
# -----------------------------------------------------------------------------
# Purpose:
#   - Validate environment-specific OS users inside managed containers
#   - Ensure users required for application ownership already exist
#
# Design Principles:
#   - Users are CREATED at Docker image build time (Dockerfile)
#   - Ansible DOES NOT create or modify OS users in containers
#   - Ansible connects as non-root user and escalates via sudo (become)
#   - Fail fast if expected users are missing
# =============================================================================

# -----------------------------------------------------------------------------
# Validate required variable
# -----------------------------------------------------------------------------
- name: Validate environment user variable is defined
  ansible.builtin.assert:
    that:
      - app_user is defined
      - app_user | length > 0
    fail_msg: >
      app_user is not defined.
      Ensure it is set in group_vars (dev/sit/uat/prod) or derived from ansible_user.
    success_msg: "Environment user '{{ app_user }}' is defined."

# -----------------------------------------------------------------------------
# Verify user exists (POSIX-safe)
# -----------------------------------------------------------------------------
- name: Verify environment user exists in container
  ansible.builtin.command: "getent passwd {{ app_user }}"
  register: user_check
  changed_when: false
  failed_when: user_check.rc != 0

- name: Fail if environment user is missing
  ansible.builtin.fail:
    msg: >
      User '{{ app_user }}' does not exist on {{ inventory_hostname }}.
      Docker image is misconfigured.
  when: user_check.rc != 0

# -----------------------------------------------------------------------------
# Debug user details (safe parsing)
# -----------------------------------------------------------------------------
- name: Debug environment user details
  ansible.builtin.debug:
    msg:
      user: "{{ app_user }}"
      uid: "{{ user_check.stdout.split(':')[2] }}"
      gid: "{{ user_check.stdout.split(':')[3] }}"
      home: "{{ user_check.stdout.split(':')[5] }}"
      shell: "{{ user_check.stdout.split(':')[6] }}"
      host: "{{ inventory_hostname }}"

# -----------------------------------------------------------------------------
# Optional: Validate home directory exists
# -----------------------------------------------------------------------------
- name: Verify home directory exists for environment user
  ansible.builtin.stat:
    path: "/home/{{ app_user }}"
  register: user_home

- name: Fail if home directory is missing
  ansible.builtin.fail:
    msg: >
      Home directory /home/{{ app_user }} does not exist on
      {{ inventory_hostname }}. Docker image may be misconfigured.
  when: not user_home.stat.exists

# -----------------------------------------------------------------------------
# Optional: Validate SSH directory (used by bootstrap_ssh.sh)
# -----------------------------------------------------------------------------
- name: Verify .ssh directory exists for environment user
  ansible.builtin.stat:
    path: "/home/{{ app_user }}/.ssh"
  register: ssh_dir

- name: Warn if SSH directory is missing
  ansible.builtin.debug:
    msg: >
      WARNING: /home/{{ app_user }}/.ssh does not exist yet on
      {{ inventory_hostname }}. It will be created during SSH bootstrap.
  when: not ssh_dir.stat.exists
